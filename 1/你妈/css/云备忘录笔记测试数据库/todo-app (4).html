<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待办事项管理 - 带用户系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4A90E2',
                        secondary: '#6BBBF7',
                        accent: '#E53E3E',
                        neutral: '#F3F4F6',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .task-complete {
                @apply line-through text-gray-400;
            }
            .task-incomplete::before {
                content: '';
                @apply inline-block w-2 h-2 bg-accent rounded-full mr-2;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #E6F4FF 0%, #FFFFFF 100%);
            }
            .sync-indicator {
                @apply fixed bottom-4 right-4 px-3 py-1.5 rounded-full text-sm flex items-center shadow-lg transition-all duration-300 z-50;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300;
            }
            .modal-card {
                @apply bg-white rounded-xl shadow-xl w-full max-w-md mx-4 transform transition-all duration-300;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200;
            }
        }
    </style>
</head>
<body class="font-inter min-h-screen gradient-bg flex flex-col">
    <header class="w-full py-6 px-4 md:px-8 bg-white/80 backdrop-blur-sm shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-[clamp(1.75rem,3vw,2.5rem)] font-bold text-gray-800">
                    <i class="fa fa-check-square-o mr-2 text-primary"></i>待办事项管理
                </h1>
                <p class="text-gray-500 mt-1">自动同步云</p>
            </div>
            <div id="userMenu" class="flex items-center space-x-4">
                <button id="loginBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    登录
                </button>
                <button id="registerBtn" class="px-4 py-2 bg-white text-primary border border-primary rounded-lg hover:bg-gray-50 transition-colors">
                    注册
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full px-4 md:px-8 py-8">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-md overflow-hidden" id="appContent">
            <!-- 未登录状态提示 -->
            <div id="unauthorizedView" class="p-8 text-center">
                <i class="fa fa-user-circle-o text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-2xl font-semibold text-gray-700 mb-2">请先登录</h2>
                <p class="text-gray-500 mb-6">登录后即可使用待办事项管理和同步功能</p>
                <div class="flex justify-center space-x-4">
                    <button id="loginBtn2" class="px-6 py-2.5 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        登录
                    </button>
                    <button id="registerBtn2" class="px-6 py-2.5 bg-white text-primary border border-primary rounded-lg hover:bg-gray-50 transition-colors">
                        注册
                    </button>
                </div>
            </div>

            <!-- 已登录状态内容 (默认隐藏) -->
            <div id="authorizedView" class="hidden">
                <div class="flex flex-col md:flex-row">
                    <!-- 左侧：添加任务区域 -->
                    <div class="p-6 md:p-8 border-b md:border-b-0 md:border-r border-gray-100 w-full md:w-1/3">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fa fa-plus-circle text-primary mr-2"></i>添加新任务
                        </h2>
                        <form id="addTaskForm" class="space-y-4">
                            <div>
                                <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">任务标题</label>
                                <input type="text" id="taskTitle" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                                    placeholder="输入任务标题..." required>
                            </div>
                            <div>
                                <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">任务描述</label>
                                <textarea id="taskDescription" rows="3" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                                    placeholder="输入任务描述..."></textarea>
                            </div>
                            <div>
                                <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-1">截止日期</label>
                                <input type="date" id="taskDueDate" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus">
                            </div>
                            <button type="submit" id="addTaskButton"
                                class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 transform hover:scale-[1.02] flex items-center justify-center">
                                <i class="fa fa-plus mr-2"></i>添加任务
                            </button>
                        </form>

                        <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <h3 class="font-medium text-primary flex items-center">
                                <i class="fa fa-info-circle mr-2"></i>账户与同步
                            </h3>
                            <p id="currentUser" class="text-sm text-gray-600 mt-1">用户: 未登录</p>
                            <p id="syncStatus" class="text-sm text-gray-600 mt-1">同步状态: 未连接</p>
                        </div>
                    </div>

                    <!-- 右侧：任务列表区域 -->
                    <div class="p-6 md:p-8 w-full md:w-2/3">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3">
                            <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                                <i class="fa fa-tasks text-primary mr-2"></i>任务列表
                            </h2>
                            <div class="flex space-x-2 w-full sm:w-auto">
                                <button id="filterAll" class="filter-btn px-3 py-1 rounded-md text-sm bg-primary text-white w-full sm:w-auto">全部</button>
                                <button id="filterActive" class="filter-btn px-3 py-1 rounded-md text-sm bg-gray-100 hover:bg-gray-200 w-full sm:w-auto">未完成</button>
                                <button id="filterCompleted" class="filter-btn px-3 py-1 rounded-md text-sm bg-gray-100 hover:bg-gray-200 w-full sm:w-auto">已完成</button>
                            </div>
                        </div>

                        <!-- 任务统计 -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">总任务数</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalTasks">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">已完成</p>
                                    <p class="text-2xl font-bold text-green-500" id="completedTasks">0</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">未完成</p>
                                    <p class="text-2xl font-bold text-accent" id="pendingTasks">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- 任务列表 -->
                        <div id="taskList" class="space-y-3 max-h-[calc(100vh-350px)] overflow-y-auto pr-2">
                            <!-- 任务项会通过JavaScript动态添加 -->
                            <div class="text-center text-gray-400 py-10" id="emptyTaskList">
                                <i class="fa fa-inbox text-4xl mb-3 block"></i>
                                <p>暂无任务，请添加新任务</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full py-4 px-4 md:px-8 bg-white/80 backdrop-blur-sm shadow-inner">
        <div class="max-w-6xl mx-auto text-center text-sm text-gray-500">
            <p>© 2025 待办事项管理应用 | 自动同步至D1数据库</p>
        </div>
    </footer>

    <!-- 同步指示器 -->
    <div id="syncIndicator" class="sync-indicator hidden">
        <i class="fa fa-spinner fa-spin mr-2"></i>
        <span id="syncMessage">同步中...</span>
    </div>

    <!-- 登录模态框 -->
    <div id="loginModal" class="modal-backdrop opacity-0 pointer-events-none">
        <div class="modal-card scale-95">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">用户登录</h2>
                    <button id="closeLoginModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                        <input type="email" id="loginEmail" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请输入邮箱" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input type="password" id="loginPassword" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请输入密码" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="forgotPasswordBtn" class="text-sm text-primary hover:text-primary/80">
                            忘记密码?
                        </button>
                    </div>
                    <button type="submit" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200">
                        登录
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">还没有账号? <button id="switchToRegister" class="text-primary font-medium">立即注册</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="registerModal" class="modal-backdrop opacity-0 pointer-events-none">
        <div class="modal-card scale-95">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">用户注册</h2>
                    <button id="closeRegisterModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                        <input type="email" id="registerEmail" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请输入邮箱" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input type="password" id="registerPassword" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请设置密码（至少6位）" minlength="6" required>
                    </div>
                    <div>
                        <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                        <input type="password" id="registerConfirmPassword" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请再次输入密码" minlength="6" required>
                    </div>
                    <div>
                        <label for="securityCode" class="block text-sm font-medium text-gray-700 mb-1">
                            防忘码 <span class="text-xs text-gray-500">(用于找回密码，请牢记)</span>
                        </label>
                        <input type="text" id="securityCode" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请设置防忘码（至少6位）" minlength="6" required>
                    </div>
                    <button type="submit" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200">
                        注册
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">已有账号? <button id="switchToLogin" class="text-primary font-medium">立即登录</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 找回密码模态框 -->
    <div id="forgotPasswordModal" class="modal-backdrop opacity-0 pointer-events-none">
        <div class="modal-card scale-95">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">找回密码</h2>
                    <button id="closeForgotPasswordModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="forgotPasswordForm" class="space-y-4">
                    <div>
                        <label for="forgotEmail" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                        <input type="email" id="forgotEmail" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请输入注册邮箱" required>
                    </div>
                    <div>
                        <label for="forgotSecurityCode" class="block text-sm font-medium text-gray-700 mb-1">防忘码</label>
                        <input type="text" id="forgotSecurityCode" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请输入防忘码" required>
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                        <input type="password" id="newPassword" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus"
                            placeholder="请设置新密码（至少6位）" minlength="6" required>
                    </div>
                    <button type="submit" 
                        class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200">
                        重置密码
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">想起密码了? <button id="backToLogin" class="text-primary font-medium">返回登录</button></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 工具函数 - 加密处理
        class CryptoUtil {
            // 简单哈希函数（实际环境建议用bcrypt）
            static hash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 转换为32位整数
                }
                return Math.abs(hash).toString(16);
            }
        }

        // D1数据库同步服务客户端（修复：不使用first操作，改用all并取第一条记录）
        class D1SyncClient {
            constructor() {
                this.apiUrl = 'https://00.naxid.top/'; // 你的Worker域名
                this.initDone = false;
                this.userId = null; // 当前登录用户ID
            }

            // 设置当前用户ID
            setUserId(userId) {
                this.userId = userId;
            }

            // 初始化数据库（创建表结构）
            async initDatabase() {
                if (this.initDone) return true;

                try {
                    // 先删除旧表（避免结构冲突）
                    await this.execute('DROP TABLE IF EXISTS tasks');
                    await this.execute('DROP TABLE IF EXISTS users');
                    
                    // 创建用户表（下划线命名法，兼容SQL规范）
                    await this.execute(`
                        CREATE TABLE IF NOT EXISTS users (
                            \`id\` TEXT PRIMARY KEY,
                            \`email\` TEXT NOT NULL UNIQUE,
                            \`password\` TEXT NOT NULL,
                            \`security_code\` TEXT NOT NULL,
                            \`created_at\` TEXT NOT NULL,
                            \`updated_at\` TEXT NOT NULL
                        )
                    `);

                    // 创建任务表（关联用户ID，实现数据隔离）
                    await this.execute(`
                        CREATE TABLE IF NOT EXISTS tasks (
                            \`id\` TEXT PRIMARY KEY,
                            \`user_id\` TEXT NOT NULL,
                            \`title\` TEXT NOT NULL,
                            \`description\` TEXT,
                            \`due_date\` TEXT,
                            \`completed\` INTEGER DEFAULT 0,
                            \`created_at\` TEXT NOT NULL,
                            \`updated_at\` TEXT NOT NULL,
                            FOREIGN KEY (\`user_id\`) REFERENCES users(\`id\`)
                        )
                    `);

                    // 创建索引提升查询性能
                    await this.execute('CREATE INDEX IF NOT EXISTS idx_tasks_user_id ON tasks(\`user_id\`)');
                    await this.execute('CREATE INDEX IF NOT EXISTS idx_tasks_completed ON tasks(\`completed\`)');
                    
                    this.initDone = true;
                    return true;
                } catch (error) {
                    console.error('数据库初始化失败:', error);
                    throw new Error('初始化数据库失败: ' + error.message);
                }
            }

            // 用户注册（含管理账号特殊处理）
            async register(email, password, securityCode) {
                const id = Date.now().toString();
                const now = new Date().toISOString();
                
                // 加密密码和防忘码（避免明文存储）
                const hashedPassword = CryptoUtil.hash(password);
                const hashedSecurityCode = CryptoUtil.hash(securityCode);
                
                try {
                    // 检查邮箱是否已注册（修复：使用all代替first）
                    const existingUsers = await this.queryAll(
                        'SELECT \`id\` FROM users WHERE \`email\` = ? LIMIT 1',
                        [email]
                    );
                    const existingUser = existingUsers.length > 0 ? existingUsers[0] : null;
                    
                    if (existingUser) {
                        throw new Error('该邮箱已被注册');
                    }
                    
                    // 插入新用户
                    await this.execute(
                        `INSERT INTO users 
                            (\`id\`, \`email\`, \`password\`, \`security_code\`, \`created_at\`, \`updated_at\`) 
                         VALUES (?, ?, ?, ?, ?, ?)`,
                        [id, email, hashedPassword, hashedSecurityCode, now, now]
                    );
                    
                    // 管理账号特殊逻辑：注册时自动初始化数据库
                    if (email === 'naxid@naxid.top' && password === 'naxid12') {
                        await this.initDatabase();
                        this.showNotification('管理账号注册成功，数据库已自动初始化');
                    }
                    
                    return { success: true, userId: id };
                } catch (error) {
                    console.error('注册失败:', error);
                    throw error;
                }
            }

            // 用户登录（修复：使用all代替first）
            async login(email, password) {
                const hashedPassword = CryptoUtil.hash(password);
                
                try {
                    // 修复：使用all方法并获取第一条记录
                    const users = await this.queryAll(
                        'SELECT \`id\`, \`email\` FROM users WHERE \`email\` = ? AND \`password\` = ? LIMIT 1',
                        [email, hashedPassword]
                    );
                    const user = users.length > 0 ? users[0] : null;
                    
                    if (!user) {
                        throw new Error('邮箱或密码错误');
                    }
                    
                    return { success: true, userId: user.id, email: user.email };
                } catch (error) {
                    console.error('登录失败:', error);
                    throw error;
                }
            }

            // 找回密码（通过防忘码验证）
            async resetPassword(email, securityCode, newPassword) {
                const hashedSecurityCode = CryptoUtil.hash(securityCode);
                const hashedNewPassword = CryptoUtil.hash(newPassword);
                const now = new Date().toISOString();
                
                try {
                    // 修复：使用all代替first
                    const users = await this.queryAll(
                        'SELECT \`id\` FROM users WHERE \`email\` = ? AND \`security_code\` = ? LIMIT 1',
                        [email, hashedSecurityCode]
                    );
                    const user = users.length > 0 ? users[0] : null;
                    
                    if (!user) {
                        throw new Error('邮箱或防忘码错误');
                    }
                    
                    // 更新密码
                    await this.execute(
                        'UPDATE users SET \`password\` = ?, \`updated_at\` = ? WHERE \`id\` = ?',
                        [hashedNewPassword, now, user.id]
                    );
                    
                    return { success: true };
                } catch (error) {
                    console.error('密码重置失败:', error);
                    throw error;
                }
            }

            // 获取当前用户的所有任务
            async getTasks() {
                if (!this.userId) {
                    throw new Error('未登录或用户ID未设置');
                }
                
                try {
                    const tasks = await this.queryAll(
                        'SELECT * FROM tasks WHERE \`user_id\` = ? ORDER BY \`created_at\` DESC',
                        [this.userId]
                    );
                    
                    // 转换D1布尔值（1/0）为JS布尔值
                    return tasks.map(task => ({
                        id: task.id,
                        userId: task.user_id,
                        title: task.title,
                        description: task.description,
                        dueDate: task.due_date,
                        completed: task.completed === 1,
                        createdAt: task.created_at,
                        updatedAt: task.updated_at
                    }));
                } catch (error) {
                    console.error('获取任务失败:', error);
                    throw error;
                }
            }

            // 添加任务到数据库
            async addTask(task) {
                if (!this.userId) {
                    throw new Error('未登录或用户ID未设置');
                }
                
                try {
                    await this.execute(
                        `INSERT INTO tasks 
                            (\`id\`, \`user_id\`, \`title\`, \`description\`, \`due_date\`, \`completed\`, \`created_at\`, \`updated_at\`) 
                         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                        [
                            task.id,
                            this.userId,
                            task.title,
                            task.description || '',
                            task.dueDate || '',
                            task.completed ? 1 : 0,
                            task.createdAt,
                            task.updatedAt
                        ]
                    );
                    return true;
                } catch (error) {
                    console.error('添加任务失败:', error);
                    throw error;
                }
            }

            // 更新任务完成状态
            async updateTaskStatus(taskId, completed) {
                if (!this.userId) {
                    throw new Error('未登录或用户ID未设置');
                }
                
                try {
                    const now = new Date().toISOString();
                    await this.execute(
                        'UPDATE tasks SET \`completed\` = ?, \`updated_at\` = ? WHERE \`id\` = ? AND \`user_id\` = ?',
                        [completed ? 1 : 0, now, taskId, this.userId]
                    );
                    return true;
                } catch (error) {
                    console.error('更新任务状态失败:', error);
                    throw error;
                }
            }

            // 删除任务
            async deleteTask(taskId) {
                if (!this.userId) {
                    throw new Error('未登录或用户ID未设置');
                }
                
                try {
                    await this.execute(
                        'DELETE FROM tasks WHERE \`id\` = ? AND \`user_id\` = ?',
                        [taskId, this.userId]
                    );
                    return true;
                } catch (error) {
                    console.error('删除任务失败:', error);
                    throw error;
                }
            }

            // 执行写操作（INSERT/UPDATE/DELETE）
            async execute(sql, params = []) {
                return this._request('exec', sql, params);
            }

            // 查询多条记录
            async queryAll(sql, params = []) {
                const result = await this._request('all', sql, params);
                return result.results || [];
            }

            // 核心请求方法（与Worker通信）
            async _request(action, sql, params) {
                try {
                    // 构建符合Worker要求的请求体
                    const requestBody = {
                        action: action,
                        query: sql,
                        params: params
                    };
                    
                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    // 处理响应
                    const responseText = await response.text();
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(`服务器返回无效JSON: ${responseText}`);
                    }

                    // 检查请求状态
                    if (!response.ok) {
                        throw new Error(`服务器错误: ${response.status} - ${data.error || response.statusText}`);
                    }

                    if (!data.success) {
                        throw new Error(data.error || '操作失败');
                    }

                    return data.data;
                } catch (error) {
                    console.error(`[D1Sync] ${action} 失败:`, error);
                    throw error;
                }
            }

            // 显示通知
            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 px-4 py-2 bg-green-500 text-white rounded-lg shadow-lg z-50';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // 模态框管理器（处理登录/注册/找回密码弹窗）
        class ModalManager {
            constructor() {
                // 模态框元素
                this.loginModal = document.getElementById('loginModal');
                this.registerModal = document.getElementById('registerModal');
                this.forgotPasswordModal = document.getElementById('forgotPasswordModal');
                
                // 关闭按钮
                this.closeLoginModal = document.getElementById('closeLoginModal');
                this.closeRegisterModal = document.getElementById('closeRegisterModal');
                this.closeForgotPasswordModal = document.getElementById('closeForgotPasswordModal');
                
                // 切换按钮
                this.switchToRegister = document.getElementById('switchToRegister');
                this.switchToLogin = document.getElementById('switchToLogin');
                this.forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
                this.backToLogin = document.getElementById('backToLogin');
                
                // 全局登录/注册按钮
                this.loginBtn = document.getElementById('loginBtn');
                this.registerBtn = document.getElementById('registerBtn');
                this.loginBtn2 = document.getElementById('loginBtn2');
                this.registerBtn2 = document.getElementById('registerBtn2');

                this.bindEvents();
            }

            // 绑定事件
            bindEvents() {
                // 打开模态框
                this.loginBtn.addEventListener('click', () => this.open('login'));
                this.registerBtn.addEventListener('click', () => this.open('register'));
                this.loginBtn2.addEventListener('click', () => this.open('login'));
                this.registerBtn2.addEventListener('click', () => this.open('register'));
                
                // 关闭模态框
                this.closeLoginModal.addEventListener('click', () => this.close('login'));
                this.closeRegisterModal.addEventListener('click', () => this.close('register'));
                this.closeForgotPasswordModal.addEventListener('click', () => this.close('forgot'));
                
                // 切换模态框
                this.switchToRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.close('login');
                    setTimeout(() => this.open('register'), 300);
                });
                
                this.switchToLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.close('register');
                    setTimeout(() => this.open('login'), 300);
                });
                
                this.forgotPasswordBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.close('login');
                    setTimeout(() => this.open('forgot'), 300);
                });
                
                this.backToLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.close('forgot');
                    setTimeout(() => this.open('login'), 300);
                });
                
                // 点击背景关闭模态框
                this.loginModal.addEventListener('click', (e) => {
                    if (e.target === this.loginModal) this.close('login');
                });
                
                this.registerModal.addEventListener('click', (e) => {
                    if (e.target === this.registerModal) this.close('register');
                });
                
                this.forgotPasswordModal.addEventListener('click', (e) => {
                    if (e.target === this.forgotPasswordModal) this.close('forgot');
                });
            }

            // 打开模态框
            open(type) {
                if (type === 'login') {
                    this.loginModal.classList.remove('opacity-0', 'pointer-events-none');
                    this.loginModal.querySelector('.modal-card').classList.remove('scale-95');
                    this.loginModal.querySelector('.modal-card').classList.add('scale-100');
                    document.getElementById('loginEmail').focus();
                } else if (type === 'register') {
                    this.registerModal.classList.remove('opacity-0', 'pointer-events-none');
                    this.registerModal.querySelector('.modal-card').classList.remove('scale-95');
                    this.registerModal.querySelector('.modal-card').classList.add('scale-100');
                    document.getElementById('registerEmail').focus();
                } else if (type === 'forgot') {
                    this.forgotPasswordModal.classList.remove('opacity-0', 'pointer-events-none');
                    this.forgotPasswordModal.querySelector('.modal-card').classList.remove('scale-95');
                    this.forgotPasswordModal.querySelector('.modal-card').classList.add('scale-100');
                    document.getElementById('forgotEmail').focus();
                }
                
                // 阻止页面滚动
                document.body.style.overflow = 'hidden';
            }

            // 关闭模态框
            close(type) {
                if (type === 'login') {
                    this.loginModal.classList.add('opacity-0', 'pointer-events-none');
                    this.loginModal.querySelector('.modal-card').classList.remove('scale-100');
                    this.loginModal.querySelector('.modal-card').classList.add('scale-95');
                } else if (type === 'register') {
                    this.registerModal.classList.add('opacity-0', 'pointer-events-none');
                    this.registerModal.querySelector('.modal-card').classList.remove('scale-100');
                    this.registerModal.querySelector('.modal-card').classList.add('scale-95');
                } else if (type === 'forgot') {
                    this.forgotPasswordModal.classList.add('opacity-0', 'pointer-events-none');
                    this.forgotPasswordModal.querySelector('.modal-card').classList.remove('scale-100');
                    this.forgotPasswordModal.querySelector('.modal-card').classList.add('scale-95');
                }
                
                // 恢复页面滚动
                document.body.style.overflow = '';
            }

            // 关闭所有模态框
            closeAll() {
                this.close('login');
                this.close('register');
                this.close('forgot');
            }
        }

        // 待办事项应用主类
        class TodoApp {
            constructor() {
                // 初始化核心模块
                this.d1Client = new D1SyncClient();
                this.modalManager = new ModalManager();
                
                // 状态管理
                this.tasks = [];
                this.currentFilter = 'all';
                this.currentUser = null;
                
                // 同步配置
                this.syncInterval = 30000; // 30秒自动同步
                this.syncIntervalId = null;
                
                // DOM元素缓存
                this.cacheDomElements();
                
                // 初始化应用
                this.init();
            }

            // 缓存DOM元素（避免重复查询）
            cacheDomElements() {
                this.addTaskForm = document.getElementById('addTaskForm');
                this.taskList = document.getElementById('taskList');
                this.emptyTaskList = document.getElementById('emptyTaskList');
                this.totalTasksElement = document.getElementById('totalTasks');
                this.completedTasksElement = document.getElementById('completedTasks');
                this.pendingTasksElement = document.getElementById('pendingTasks');
                this.filterButtons = document.querySelectorAll('.filter-btn');
                this.addTaskButton = document.getElementById('addTaskButton');
                this.syncStatusElement = document.getElementById('syncStatus');
                this.currentUserElement = document.getElementById('currentUser');
                this.syncIndicator = document.getElementById('syncIndicator');
                this.syncMessage = document.getElementById('syncMessage');
                this.userMenu = document.getElementById('userMenu');
                this.unauthorizedView = document.getElementById('unauthorizedView');
                this.authorizedView = document.getElementById('authorizedView');
            }

            // 初始化应用
            async init() {
                try {
                    // 初始化数据库（首次加载）
                    await this.d1Client.initDatabase();
                    
                    // 检查本地存储的登录状态
                    this.checkStoredLogin();
                    
                    // 绑定事件
                    this.bindEvents();
                } catch (error) {
                    this.showNotification(`初始化失败: ${error.message}`, true);
                    console.error('应用初始化失败:', error);
                }
            }

            // 检查本地存储的登录状态
            checkStoredLogin() {
                const storedUser = localStorage.getItem('todoUser');
                if (storedUser) {
                    try {
                        const user = JSON.parse(storedUser);
                        this.loginSuccess(user.userId, user.email);
                    } catch (error) {
                        console.error('解析存储的用户信息失败:', error);
                        localStorage.removeItem('todoUser');
                    }
                }
            }

            // 绑定事件处理程序
            bindEvents() {
                // 任务过滤
                document.getElementById('filterAll').addEventListener('click', () => this.setFilter('all'));
                document.getElementById('filterActive').addEventListener('click', () => this.setFilter('active'));
                document.getElementById('filterCompleted').addEventListener('click', () => this.setFilter('completed'));
                
                // 添加任务
                this.addTaskForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTask();
                });
                
                // 登录/注册/找回密码表单
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin();
                });
                document.getElementById('registerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleRegister();
                });
                document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleResetPassword();
                });
            }

            // 处理登录逻辑
            async handleLogin() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                try {
                    this.showSyncIndicator('正在登录...');
                    const result = await this.d1Client.login(email, password);
                    
                    if (result.success) {
                        this.loginSuccess(result.userId, email);
                        this.modalManager.closeAll();
                        document.getElementById('loginForm').reset();
                        this.showSyncIndicator('登录成功', false, 2000);
                    }
                } catch (error) {
                    this.showSyncIndicator(`登录失败: ${error.message}`, true, 3000);
                    console.error('登录失败:', error);
                }
            }

            // 处理注册逻辑
            async handleRegister() {
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const securityCode = document.getElementById('securityCode').value.trim();
                
                // 客户端验证
                if (password !== confirmPassword) {
                    this.showSyncIndicator('两次输入的密码不一致', true, 3000);
                    return;
                }
                if (password.length < 6) {
                    this.showSyncIndicator('密码长度不能少于6位', true, 3000);
                    return;
                }
                if (securityCode.length < 6) {
                    this.showSyncIndicator('防忘码长度不能少于6位', true, 3000);
                    return;
                }
                
                try {
                    this.showSyncIndicator('正在注册...');
                    const result = await this.d1Client.register(email, password, securityCode);
                    
                    if (result.success) {
                        this.loginSuccess(result.userId, email);
                        this.modalManager.closeAll();
                        document.getElementById('registerForm').reset();
                        this.showSyncIndicator('注册成功', false, 2000);
                    }
                } catch (error) {
                    this.showSyncIndicator(`注册失败: ${error.message}`, true, 3000);
                    console.error('注册失败:', error);
                }
            }

            // 处理密码重置
            async handleResetPassword() {
                const email = document.getElementById('forgotEmail').value.trim();
                const securityCode = document.getElementById('forgotSecurityCode').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                
                try {
                    this.showSyncIndicator('正在验证并重置密码...');
                    const result = await this.d1Client.resetPassword(email, securityCode, newPassword);
                    
                    if (result.success) {
                        this.modalManager.close('forgot');
                        setTimeout(() => this.modalManager.open('login'), 300);
                        document.getElementById('forgotPasswordForm').reset();
                        this.showSyncIndicator('密码重置成功，请重新登录', false, 3000);
                    }
                } catch (error) {
                    this.showSyncIndicator(`重置失败: ${error.message}`, true, 3000);
                    console.error('密码重置失败:', error);
                }
            }

            // 登录成功后的处理
            loginSuccess(userId, email) {
                // 保存用户信息
                this.currentUser = { userId, email };
                this.d1Client.setUserId(userId);
                
                // 本地存储（记住登录状态）
                localStorage.setItem('todoUser', JSON.stringify({ userId, email }));
                
                // 更新UI
                this.updateUserInterface();
                
                // 加载用户任务
                this.loadUserTasks();
                
                // 启动自动同步
                this.startAutoSync();
            }

            // 退出登录
            logout() {
                if (confirm('确定要退出登录吗？')) {
                    // 清除状态
                    this.currentUser = null;
                    this.d1Client.setUserId(null);
                    this.tasks = [];
                    
                    // 清除本地存储
                    localStorage.removeItem('todoUser');
                    
                    // 停止自动同步
                    this.stopAutoSync();
                    
                    // 更新UI
                    this.updateUserInterface();
                    this.renderTasks();
                    this.updateTaskStats();
                }
            }

            // 更新用户界面（切换登录/未登录状态）
            updateUserInterface() {
                if (this.currentUser) {
                    // 已登录状态
                    this.unauthorizedView.classList.add('hidden');
                    this.authorizedView.classList.remove('hidden');
                    
                    // 显示当前用户
                    this.currentUserElement.textContent = `用户: ${this.currentUser.email}`;
                    
                    // 更新用户菜单（显示退出按钮）
                    this.userMenu.innerHTML = `
                        <span class="text-gray-700">${this.currentUser.email}</span>
                        <button id="logoutBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            退出登录
                        </button>
                    `;
                    
                    // 绑定退出事件
                    document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                    
                    this.updateSyncStatus('已连接，等待同步...');
                } else {
                    // 未登录状态
                    this.unauthorizedView.classList.remove('hidden');
                    this.authorizedView.classList.add('hidden');
                    
                    // 恢复登录/注册按钮
                    this.userMenu.innerHTML = `
                        <button id="loginBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            登录
                        </button>
                        <button id="registerBtn" class="px-4 py-2 bg-white text-primary border border-primary rounded-lg hover:bg-gray-50 transition-colors">
                            注册
                        </button>
                    `;
                    
                    // 重新绑定按钮事件
                    this.modalManager.loginBtn = document.getElementById('loginBtn');
                    this.modalManager.registerBtn = document.getElementById('registerBtn');
                    this.modalManager.loginBtn.addEventListener('click', () => this.modalManager.open('login'));
                    this.modalManager.registerBtn.addEventListener('click', () => this.modalManager.open('register'));
                }
            }

            // 设置任务过滤条件
            setFilter(filter) {
                this.currentFilter = filter;
                this.filterButtons.forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                });
                
                const activeBtn = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
                activeBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                activeBtn.classList.add('bg-primary', 'text-white');
                
                this.renderTasks();
            }

            // 添加新任务
            async addTask() {
                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                const dueDate = document.getElementById('taskDueDate').value;
                
                if (!title) return;
                
                const now = new Date().toISOString();
                const newTask = {
                    id: Date.now().toString(),
                    title,
                    description,
                    dueDate,
                    completed: false,
                    createdAt: now,
                    updatedAt: now
                };
                
                try {
                    // 本地更新
                    this.tasks.unshift(newTask);
                    this.saveLocalTasks();
                    this.renderTasks();
                    this.updateTaskStats();
                    
                    // 同步到数据库
                    this.showSyncIndicator('正在保存任务...');
                    await this.d1Client.addTask(newTask);
                    
                    // 重置表单和反馈
                    this.addTaskForm.reset();
                    this.addTaskButton.classList.add('bg-green-500');
                    setTimeout(() => this.addTaskButton.classList.remove('bg-green-500'), 300);
                    
                    this.showSyncIndicator('任务已保存', false, 2000);
                    this.updateSyncStatus('任务添加成功并已同步');
                } catch (error) {
                    console.error('添加任务失败:', error);
                    this.showSyncIndicator(`保存失败: ${error.message}`, true, 3000);
                    this.updateSyncStatus(`添加失败: ${error.message}`, true);
                }
            }

            // 切换任务完成状态
            async toggleTaskStatus(taskId) {
                const taskIndex = this.tasks.findIndex(task => task.id === taskId);
                if (taskIndex === -1) return;
                
                // 切换状态
                const newStatus = !this.tasks[taskIndex].completed;
                const now = new Date().toISOString();
                
                // 本地更新
                this.tasks[taskIndex] = {
                    ...this.tasks[taskIndex],
                    completed: newStatus,
                    updatedAt: now
                };
                
                this.saveLocalTasks();
                this.renderTasks();
                this.updateTaskStats();
                
                try {
                    // 同步到数据库
                    this.showSyncIndicator('正在更新任务状态...');
                    await this.d1Client.updateTaskStatus(taskId, newStatus);
                    
                    this.showSyncIndicator('任务状态已更新', false, 2000);
                    this.updateSyncStatus('任务状态已同步');
                } catch (error) {
                    console.error('更新任务状态失败:', error);
                    this.showSyncIndicator(`更新失败: ${error.message}`, true, 3000);
                    this.updateSyncStatus(`更新状态失败: ${error.message}`, true);
                }
            }

            // 删除任务
            async deleteTask(taskId) {
                if (!confirm('确定要删除这个任务吗？')) return;
                
                try {
                    // 本地删除
                    this.tasks = this.tasks.filter(task => task.id !== taskId);
                    this.saveLocalTasks();
                    this.renderTasks();
                    this.updateTaskStats();
                    
                    // 同步到数据库
                    this.showSyncIndicator('正在删除任务...');
                    await this.d1Client.deleteTask(taskId);
                    
                    this.showSyncIndicator('任务已删除', false, 2000);
                    this.updateSyncStatus('任务已删除并同步');
                } catch (error) {
                    console.error('删除任务失败:', error);
                    this.showSyncIndicator(`删除失败: ${error.message}`, true, 3000);
                    this.updateSyncStatus(`删除任务失败: ${error.message}`, true);
                }
            }

            // 加载用户任务
            async loadUserTasks() {
                try {
                    this.showSyncIndicator('正在加载任务...');
                    this.updateSyncStatus('正在加载您的任务...');
                    
                    // 从数据库获取任务
                    const serverTasks = await this.d1Client.getTasks();
                    
                    // 本地更新
                    this.tasks = serverTasks;
                    this.saveLocalTasks();
                    this.renderTasks();
                    this.updateTaskStats();
                    
                    this.showSyncIndicator('任务加载完成', false, 2000);
                    this.updateSyncStatus(`已加载 ${this.tasks.length} 个任务`);
                    
                    return true;
                } catch (error) {
                    console.error('加载任务失败:', error);
                    // 降级使用本地存储
                    this.loadLocalTasks();
                    this.renderTasks();
                    this.updateTaskStats();
                    
                    this.showSyncIndicator(`加载失败: ${error.message}，使用本地数据`, true, 3000);
                    this.updateSyncStatus(`加载失败: ${error.message}，使用本地数据`, true);
                    return false;
                }
            }

            // 与数据库同步数据
            async syncWithServer() {
                if (!this.currentUser) return false;
                return this.loadUserTasks();
            }

            // 启动自动同步
            startAutoSync() {
                this.stopAutoSync(); // 先停止已有定时器
                this.syncIntervalId = setInterval(async () => {
                    if (this.currentFilter === 'all') { // 只在"全部"过滤下同步
                        await this.syncWithServer();
                    }
                }, this.syncInterval);
                
                this.updateSyncStatus(`自动同步已开启（每 ${this.syncInterval/1000} 秒）`);
            }

            // 停止自动同步
            stopAutoSync() {
                if (this.syncIntervalId) {
                    clearInterval(this.syncIntervalId);
                    this.syncIntervalId = null;
                }
            }

            // 保存任务到本地存储（按用户隔离）
            saveLocalTasks() {
                if (this.currentUser) {
                    localStorage.setItem(`todoTasks_${this.currentUser.userId}`, JSON.stringify(this.tasks));
                }
            }

            // 从本地存储加载任务
            loadLocalTasks() {
                if (this.currentUser) {
                    const storedTasks = localStorage.getItem(`todoTasks_${this.currentUser.userId}`);
                    if (storedTasks) {
                        this.tasks = JSON.parse(storedTasks);
                    }
                }
            }

            // 更新任务统计
            updateTaskStats() {
                const total = this.tasks.length;
                const completed = this.tasks.filter(task => task.completed).length;
                const pending = total - completed;
                
                this.totalTasksElement.textContent = total;
                this.completedTasksElement.textContent = completed;
                this.pendingTasksElement.textContent = pending;
            }

            // 格式化日期显示
            formatDate(dateString) {
                if (!dateString) return '无';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            }

            // 渲染任务列表
            renderTasks() {
                // 过滤任务
                let filteredTasks = [...this.tasks];
                if (this.currentFilter === 'active') {
                    filteredTasks = this.tasks.filter(task => !task.completed);
                } else if (this.currentFilter === 'completed') {
                    filteredTasks = this.tasks.filter(task => task.completed);
                }
                
                // 清空列表
                this.taskList.innerHTML = '';
                
                // 显示空状态
                if (filteredTasks.length === 0) {
                    this.taskList.appendChild(this.emptyTaskList);
                    return;
                }
                
                // 渲染任务项
                filteredTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = `task-item p-4 bg-white rounded-lg shadow-sm border-l-4 ${task.completed ? 'border-green-500' : 'border-primary'} transition-all duration-200 hover:shadow-md`;
                    
                    taskElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start">
                                    <input type="checkbox" id="task-${task.id}" ${task.completed ? 'checked' : ''} 
                                        class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded cursor-pointer transition-colors">
                                    <label for="task-${task.id}" class="ml-3 block text-sm font-medium text-gray-700 ${task.completed ? 'task-complete' : 'task-incomplete'}">
                                        ${task.title}
                                    </label>
                                </div>
                                ${task.description ? `
                                    <p class="mt-1 text-sm text-gray-500 ${task.completed ? 'task-complete' : ''}">
                                        ${task.description}
                                    </p>
                                ` : ''}
                                <div class="mt-2 flex items-center text-xs text-gray-500 flex-wrap gap-x-4 gap-y-1">
                                    <span class="flex items-center">
                                        <i class="fa fa-calendar-o mr-1 ${task.completed ? 'text-gray-400' : 'text-primary'}"></i>
                                        截止: ${this.formatDate(task.dueDate)}
                                    </span>
                                    <span class="flex items-center">
                                        <i class="fa fa-clock-o mr-1 ${task.completed ? 'text-gray-400' : 'text-primary'}"></i>
                                        创建: ${this.formatDate(task.createdAt)}
                                    </span>
                                </div>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button onclick="todoApp.deleteTask('${task.id}')" class="text-gray-400 hover:text-gray-600 focus:outline-none transition-colors">
                                    <span class="sr-only">删除任务</span>
                                    <i class="fa fa-trash-o text-lg"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 绑定复选框事件
                    const checkbox = taskElement.querySelector(`#task-${task.id}`);
                    checkbox.addEventListener('change', () => this.toggleTaskStatus(task.id));
                    
                    this.taskList.appendChild(taskElement);
                });
            }

            // 显示同步状态指示器
            showSyncIndicator(message, isError = false, duration = 3000) {
                this.syncIndicator.classList.remove('hidden', 'bg-primary/90', 'bg-green-500/90', 'bg-accent/90');
                this.syncMessage.textContent = message;
                
                if (isError) {
                    this.syncIndicator.classList.add('bg-accent/90');
                    this.syncIndicator.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i><span id="syncMessage">${message}</span>`;
                } else if (message.includes('同步中') || message.includes('正在')) {
                    this.syncIndicator.classList.add('bg-primary/90');
                    this.syncIndicator.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i><span id="syncMessage">${message}</span>`;
                } else {
                    this.syncIndicator.classList.add('bg-green-500/90');
                    this.syncIndicator.innerHTML = `<i class="fa fa-check-circle mr-2"></i><span id="syncMessage">${message}</span>`;
                }
                
                if (duration) {
                    setTimeout(() => {
                        this.syncIndicator.classList.add('hidden');
                    }, duration);
                }
            }

            // 显示顶部通知
            showNotification(message, isError = false) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${isError ? 'bg-accent' : 'bg-green-500'} z-50`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // 更新同步状态文本
            updateSyncStatus(message, isError = false) {
                this.syncStatusElement.textContent = `同步状态: ${message}`;
                this.syncStatusElement.className = `text-sm ${isError ? 'text-accent' : 'text-gray-600'} mt-1`;
            }
        }

        // 全局应用实例（供任务删除按钮调用）
        let todoApp;
        window.onload = () => {
            todoApp = new TodoApp();
        };
    </script>
</body>
</html>
