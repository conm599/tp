<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU性能检测工具 - 基于SM3和SM4算法</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #165DFF 0%, #36CFC9 100%);
            }
            .pulse-animation {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
            }
            .slide-in {
                animation: slideIn 0.5s ease-out forwards;
            }
            @keyframes slideIn {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md fixed w-full top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-microchip text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">CPU性能检测工具</h1>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#home" class="nav-link hover:text-primary transition-colors">首页</a>
                <a href="#results" class="nav-link hover:text-primary transition-colors">测试结果</a>
                <a href="#history" class="nav-link hover:text-primary transition-colors">历史记录</a>
                <a href="#about" class="nav-link hover:text-primary transition-colors">关于算法</a>
            </nav>
            <button class="md:hidden text-gray-600 focus:outline-none" id="mobile-menu-button">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div class="md:hidden hidden bg-white shadow-lg absolute w-full" id="mobile-menu">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
                <a href="#home" class="py-2 hover:text-primary transition-colors">首页</a>
                <a href="#results" class="py-2 hover:text-primary transition-colors">测试结果</a>
                <a href="#history" class="py-2 hover:text-primary transition-colors">历史记录</a>
                <a href="#about" class="py-2 hover:text-primary transition-colors">关于算法</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pt-24 pb-16">
        <!-- 1. 项目概述区域 -->
        <section id="home" class="mb-16 slide-in">
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div class="gradient-bg text-white p-6 rounded-lg mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold mb-3">CPU性能检测工具</h2>
                    <p class="text-lg opacity-90">通过SM3哈希算法和SM4加密算法测试您的处理器性能</p>
                </div>
                
                <p class="text-gray-700 mb-6">
                    本工具通过运行国密标准的SM3哈希算法和SM4加密算法，计算处理器每秒钟能够完成的运算次数，
                    以此评估CPU的计算性能。测试结果将以直观的方式展示，并提供性能评价和历史记录对比。
                </p>
                
                <!-- 系统信息卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center mb-2">
                            <i class="fa fa-desktop text-primary mr-2"></i>
                            <h3 class="font-semibold">浏览器</h3>
                        </div>
                        <p id="browser-info" class="text-gray-600">获取中...</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center mb-2">
                            <i class="fa fa-clock-o text-primary mr-2"></i>
                            <h3 class="font-semibold">系统时间</h3>
                        </div>
                        <p id="system-time" class="text-gray-600">获取中...</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center mb-2">
                            <i class="fa fa-memory text-primary mr-2"></i>
                            <h3 class="font-semibold">内存</h3>
                        </div>
                        <p id="memory-info" class="text-gray-600">获取中...</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center mb-2">
                            <i class="fa fa-microchip text-primary mr-2"></i>
                            <h3 class="font-semibold">CPU核心</h3>
                        </div>
                        <p id="cpu-cores" class="text-gray-600">获取中...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. 控制区域和实时结果 -->
        <section id="results" class="mb-16 slide-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- 控制区域 -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 h-full">
                        <h2 class="text-xl font-bold mb-6 flex items-center">
                            <i class="fa fa-sliders text-primary mr-2"></i>测试控制
                        </h2>
                        
                        <div class="mb-6">
                            <label for="test-duration" class="block text-gray-700 mb-2 font-medium">测试时长</label>
                            <div class="flex items-center">
                                <input 
                                    type="range" 
                                    id="test-duration" 
                                    min="5" 
                                    max="60" 
                                    value="10" 
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary"
                                >
                                <label class="ml-3 flex items-center">
                                    <input type="checkbox" id="infinite-test" class="w-4 h-4 accent-primary">
                                    <span class="ml-1 text-sm">无限</span>
                                </label>
                            </div>
                            <div class="flex justify-between mt-1 text-sm text-gray-500">
                                <span>5秒</span>
                                <span id="duration-value">10秒</span>
                                <span>60秒</span>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 mb-2 font-medium">测试算法</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="test-sm3" checked class="w-4 h-4 accent-primary">
                                    <span class="ml-2">SM3哈希算法</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="test-sm4" checked class="w-4 h-4 accent-primary">
                                    <span class="ml-2">SM4加密算法</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 mb-2 font-medium">数据量</label>
                            <select id="data-size" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="small">小 (1KB)</option>
                                <option value="medium" selected>中 (10KB)</option>
                                <option value="large">大 (100KB)</option>
                            </select>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 mb-2 font-medium">测试线程数</label>
                            <select id="thread-count" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="1">1线程</option>
                                <option value="auto" selected>自动 (全核心)</option>
                                <option value="2">2线程</option>
                                <option value="4">4线程</option>
                                <option value="8">8线程</option>
                                <option value="16">16线程</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button id="start-test" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center">
                                <i class="fa fa-play mr-2"></i> 开始测试
                            </button>
                            <button id="stop-test" class="flex-1 bg-danger hover:bg-danger/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center" disabled>
                                <i class="fa fa-stop mr-2"></i> 停止
                            </button>
                        </div>
                        
                        <!-- 测试进度 -->
                        <div class="mt-8 hidden" id="progress-container">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-600">测试进度</span>
                                <span id="progress-percentage" class="text-sm font-medium">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-primary h-2.5 rounded-full w-0 transition-all duration-300"></div>
                            </div>
                            <div class="mt-2 text-sm text-gray-500 text-center" id="test-status">
                                准备开始...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 实时结果显示区域 -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6 h-full">
                        <h2 class="text-xl font-bold mb-6 flex items-center">
                            <i class="fa fa-line-chart text-primary mr-2"></i>实时性能指标
                        </h2>
                        
                        <!-- 测试进行中显示 -->
                        <div id="testing-view" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h3 class="text-gray-600 mb-2">SM3 哈希速度</h3>
                                    <div class="flex items-end">
                                        <span id="sm3-speed" class="text-3xl font-bold text-primary">0</span>
                                        <span class="text-gray-500 ml-2 mb-1">哈希/秒</span>
                                    </div>
                                    <div class="mt-2 text-sm text-gray-500">
                                        总计算: <span id="sm3-total">0</span> 次哈希
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h3 class="text-gray-600 mb-2">SM4 加密速度</h3>
                                    <div class="flex items-end">
                                        <span id="sm4-speed" class="text-3xl font-bold text-secondary">0</span>
                                        <span class="text-gray-500 ml-2 mb-1">加密/秒</span>
                                    </div>
                                    <div class="mt-2 text-sm text-gray-500">
                                        总计算: <span id="sm4-total">0</span> 次加密
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 实时图表 -->
                            <div class="h-64">
                                <canvas id="realtime-chart"></canvas>
                            </div>
                            
                            <!-- 线程状态 -->
                            <div class="mt-4">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">线程状态</h3>
                                <div id="thread-status" class="flex flex-wrap gap-2">
                                    <!-- 线程状态将动态添加 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 测试未开始显示 -->
                        <div id="ready-view" class="text-center py-12">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                                <i class="fa fa-play-circle-o text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">准备就绪</h3>
                            <p class="text-gray-500 max-w-md mx-auto">
                                点击"开始测试"按钮启动CPU性能检测。测试过程中请尽量避免使用其他应用程序，以获得准确结果。
                            </p>
                        </div>
                        
                        <!-- 测试完成结果 -->
                        <div id="completed-view" class="hidden">
                            <div class="bg-success/10 border border-success/20 rounded-lg p-4 mb-6">
                                <div class="flex items-center">
                                    <i class="fa fa-check-circle text-success text-xl mr-2"></i>
                                    <h3 class="font-medium text-success">测试已完成</h3>
                                </div>
                                <p class="text-gray-600 mt-1" id="completed-time">测试时间: --</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h3 class="text-gray-600 mb-2">SM3 平均速度</h3>
                                    <div class="flex items-end">
                                        <span id="sm3-avg" class="text-3xl font-bold text-primary">0</span>
                                        <span class="text-gray-500 ml-2 mb-1">哈希/秒</span>
                                    </div>
                                    <div class="mt-2 text-sm">
                                        <span id="sm3-rating" class="px-2 py-1 rounded-full bg-gray-200 text-gray-700">评级: --</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                    <h3 class="text-gray-600 mb-2">SM4 平均速度</h3>
                                    <div class="flex items-end">
                                        <span id="sm4-avg" class="text-3xl font-bold text-secondary">0</span>
                                        <span class="text-gray-500 ml-2 mb-1">加密/秒</span>
                                    </div>
                                    <div class="mt-2 text-sm">
                                        <span id="sm4-rating" class="px-2 py-1 rounded-full bg-gray-200 text-gray-700">评级: --</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <h3 class="text-gray-700 font-medium mb-3">综合性能得分</h3>
                                <div class="flex flex-col md:flex-row items-center">
                                    <div class="text-center md:text-left mb-4 md:mb-0 md:mr-8">
                                        <div class="text-5xl font-bold text-primary" id="overall-score">0</div>
                                        <div class="text-gray-500" id="performance-rating">未评级</div>
                                    </div>
                                    <div class="w-full md:w-2/3">
                                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                                            <div id="score-bar" class="h-full gradient-bg rounded-full" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>低</span>
                                            <span>中</span>
                                            <span>高</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="h-64">
                                <canvas id="results-chart"></canvas>
                            </div>
                            
                            <div class="mt-6 flex justify-end">
                                <button id="save-result" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                    <i class="fa fa-save mr-1"></i> 保存结果
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. 历史记录区域 -->
        <section id="history" class="mb-16 slide-in">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>测试历史记录
                </h2>
                
                <div id="no-history" class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 text-gray-400 mb-4">
                        <i class="fa fa-folder-open-o text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">暂无历史记录</h3>
                    <p class="text-gray-500 max-w-md mx-auto">
                        完成测试并保存结果后，将在这里显示您的历史测试记录，方便您进行性能对比。
                    </p>
                </div>
                
                <div id="history-container" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">测试时间</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SM3速度</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SM4速度</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">综合得分</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">线程数</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="history-list" class="bg-white divide-y divide-gray-200">
                                <!-- 历史记录将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="clear-history" class="text-danger hover:text-danger/80 font-medium transition-colors flex items-center">
                            <i class="fa fa-trash-o mr-1"></i> 清空历史记录
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. 信息区域 -->
        <section id="about" class="mb-16 slide-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- SM3算法说明 -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fa fa-shield text-primary mr-2"></i>SM3哈希算法
                    </h2>
                    <p class="text-gray-700 mb-4">
                        SM3是中国国家密码管理局发布的密码杂凑算法标准，于2010年公布。
                        它适用于数字签名和验证、消息认证码生成与验证以及随机数生成等场景。
                    </p>
                    <p class="text-gray-700 mb-4">
                        该算法的压缩函数采用Merkle-Damgård结构，消息分组长度为512位，输出哈希值长度为256位，
                        具有较高的安全性和抗碰撞能力。
                    </p>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-medium mb-2 text-gray-700">测试原理</h3>
                        <p class="text-gray-600 text-sm">
                            本工具通过连续计算随机数据的SM3哈希值，统计单位时间内完成的哈希计算次数，
                            以此评估CPU在密码学哈希计算方面的性能。
                        </p>
                    </div>
                </div>
                
                <!-- SM4算法说明 -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fa fa-lock text-primary mr-2"></i>SM4加密算法
                    </h2>
                    <p class="text-gray-700 mb-4">
                        SM4是中国国家密码管理局发布的分组密码算法，原名SMS4，于2012年正式公布为国家标准。
                        它主要用于无线局域网产品中的数据加密。
                    </p>
                    <p class="text-gray-700 mb-4">
                        该算法为对称加密算法，分组长度和密钥长度均为128位，采用Feistel结构，
                        具有高效、安全、易于实现等特点，适用于各种需要数据加密保护的场景。
                    </p>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="font-medium mb-2 text-gray-700">测试原理</h3>
                        <p class="text-gray-600 text-sm">
                            本工具通过使用SM4算法对随机数据进行加密和解密操作，统计单位时间内完成的加密次数，
                            以此评估CPU在对称加密计算方面的性能。
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <i class="fa fa-microchip text-primary text-xl mr-2"></i>
                        <span class="font-bold text-lg">CPU性能检测工具</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">基于SM3和SM4算法的性能评估</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-info-circle text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-question-circle text-xl"></i>
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
                &copy; 2023 CPU性能检测工具 | 基于国密算法SM3和SM4
            </div>
        </div>
    </footer>

    <!-- 通知提示框 -->
    <div id="toast" class="fixed bottom-6 right-6 bg-dark text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
        <i id="toast-icon" class="fa fa-check-circle mr-2 text-success"></i>
        <span id="toast-message">操作成功</span>
    </div>

    <!-- Web Worker脚本 (内联) -->
    <script id="worker-script" type="javascript/worker">
        // 全局变量
        let isRunning = false;
        let sm3Count = 0;
        let sm4Count = 0;
        let testDuration = 10;
        let isInfinite = false;
        let testSM3 = true;
        let testSM4 = true;
        let dataSize = 'medium';
        let testData = null;
        let sm4Key = null;
        let startTime = 0;
        let lastReportedTime = 0;
        let workerId = 0;
        
        // 分块生成测试数据，解决crypto.getRandomValues的大小限制
        function generateTestData(size) {
            const MAX_CHUNK_SIZE = 65536; // 64KB，crypto.getRandomValues的最大单次大小
            let totalLength;
            
            switch(size) {
                case 'small': totalLength = 1024; break; // 1KB
                case 'medium': totalLength = 10240; break; // 10KB
                case 'large': totalLength = 102400; break; // 100KB
                default: totalLength = 10240;
            }
            
            const result = new Uint8Array(totalLength);
            let offset = 0;
            
            // 分块生成随机数据
            while (offset < totalLength) {
                const chunkSize = Math.min(MAX_CHUNK_SIZE, totalLength - offset);
                const chunk = new Uint8Array(chunkSize);
                crypto.getRandomValues(chunk);
                result.set(chunk, offset);
                offset += chunkSize;
            }
            
            return result;
        }
        
        // 生成SM4密钥
        function generateSM4Key() {
            const key = new Uint8Array(16); // SM4密钥长度为16字节
            crypto.getRandomValues(key);
            return key;
        }
        
        // SM3算法实现 - 简化版用于性能测试
        class SM3 {
            static hash(data) {
                // 初始化向量
                let h0 = 0x7380166F;
                let h1 = 0x4914B2B9;
                let h2 = 0x172442D7;
                let h3 = 0xDA8A0600;
                let h4 = 0xA96F30BC;
                let h5 = 0x163138AA;
                let h6 = 0xE38DEE4D;
                let h7 = 0xB0FB0E4E;
                
                // 简化的压缩函数
                for (let i = 0; i < data.length; i++) {
                    let temp = h0 ^ data[i];
                    h0 = h1;
                    h1 = h2;
                    h2 = h3;
                    h3 = h4;
                    h4 = h5;
                    h5 = h6;
                    h6 = h7;
                    h7 = temp;
                }
                
                return [h0, h1, h2, h3, h4, h5, h6, h7];
            }
        }
        
        // SM4算法实现 - 简化版用于性能测试
        class SM4 {
            static encrypt(data, key) {
                const result = new Uint8Array(data.length);
                const keyLen = key.length;
                
                // 简化的加密过程
                for (let i = 0; i < data.length; i++) {
                    // 使用简单的异或操作和轮换作为简化加密
                    result[i] = (data[i] ^ key[i % keyLen] + i) % 256;
                }
                
                return result;
            }
        }
        
        // 执行一次测试迭代
        function runOneIteration() {
            if (!isRunning) return false;
            
            // 执行SM3测试
            if (testSM3) {
                SM3.hash(testData);
                sm3Count++;
            }
            
            // 执行SM4测试
            if (testSM4) {
                SM4.encrypt(testData, sm4Key);
                sm4Count++;
            }
            
            return true;
        }
        
        // 批量执行测试迭代并报告进度
        function runTestBatch(batchSize = 100) {
            if (!isRunning) return;
            
            // 执行一批测试
            for (let i = 0; i < batchSize; i++) {
                if (!runOneIteration()) {
                    return;
                }
            }
            
            // 检查是否需要报告进度（至少每0.5秒报告一次）
            const now = Date.now();
            if (now - lastReportedTime > 500) {
                const elapsed = (now - startTime) / 1000;
                let progress = 100;
                
                // 非无限模式下计算进度
                if (!isInfinite) {
                    progress = (elapsed / testDuration) * 100;
                    progress = Math.min(progress, 100);
                }
                
                self.postMessage({
                    type: 'progress',
                    workerId,
                    sm3Count,
                    sm4Count,
                    progress: Math.min(progress, 100)
                });
                
                lastReportedTime = now;
            }
            
            // 非无限模式下检查是否达到测试时长
            if (!isInfinite && (now - startTime) / 1000 >= testDuration) {
                isRunning = false;
                self.postMessage({
                    type: 'complete',
                    workerId,
                    sm3Count,
                    sm4Count,
                    duration: (now - startTime) / 1000
                });
                return;
            }
            
            // 继续下一批测试
            requestAnimationFrame(() => runTestBatch(batchSize));
        }
        
        // 处理来自主线程的消息
        self.onmessage = function(e) {
            try {
                switch(e.data.type) {
                    case 'start':
                        workerId = e.data.workerId;
                        testDuration = e.data.duration;
                        isInfinite = e.data.isInfinite;
                        testSM3 = e.data.testSM3;
                        testSM4 = e.data.testSM4;
                        dataSize = e.data.dataSize;
                        
                        // 生成测试数据和密钥
                        testData = generateTestData(dataSize);
                        sm4Key = generateSM4Key();
                        
                        // 初始化计数器
                        sm3Count = 0;
                        sm4Count = 0;
                        isRunning = true;
                        startTime = Date.now();
                        lastReportedTime = startTime;
                        
                        self.postMessage({ 
                            type: 'started',
                            workerId
                        });
                        
                        // 根据测试算法调整批处理大小
                        const batchSize = testSM3 && testSM4 ? 50 : 100;
                        runTestBatch(batchSize);
                        break;
                        
                    case 'stop':
                        isRunning = false;
                        const elapsed = (Date.now() - startTime) / 1000;
                        self.postMessage({
                            type: 'stopped',
                            workerId,
                            sm3Count,
                            sm4Count,
                            duration: elapsed
                        });
                        break;
                }
            } catch (error) {
                self.postMessage({
                    type: 'error',
                    workerId,
                    message: error.message
                });
            }
        };
    </script>

    <script>
        // DOM元素引用
        const elements = {
            // 导航
            navbar: document.getElementById('navbar'),
            mobileMenuButton: document.getElementById('mobile-menu-button'),
            mobileMenu: document.getElementById('mobile-menu'),
            navLinks: document.querySelectorAll('.nav-link'),
            
            // 系统信息
            browserInfo: document.getElementById('browser-info'),
            systemTime: document.getElementById('system-time'),
            memoryInfo: document.getElementById('memory-info'),
            cpuCores: document.getElementById('cpu-cores'),
            
            // 测试控制
            startTest: document.getElementById('start-test'),
            stopTest: document.getElementById('stop-test'),
            testDuration: document.getElementById('test-duration'),
            durationValue: document.getElementById('duration-value'),
            infiniteTest: document.getElementById('infinite-test'),
            testSm3: document.getElementById('test-sm3'),
            testSm4: document.getElementById('test-sm4'),
            dataSize: document.getElementById('data-size'),
            threadCount: document.getElementById('thread-count'),
            
            // 进度显示
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressPercentage: document.getElementById('progress-percentage'),
            testStatus: document.getElementById('test-status'),
            
            // 视图切换
            testingView: document.getElementById('testing-view'),
            readyView: document.getElementById('ready-view'),
            completedView: document.getElementById('completed-view'),
            
            // 实时数据
            sm3Speed: document.getElementById('sm3-speed'),
            sm3Total: document.getElementById('sm3-total'),
            sm4Speed: document.getElementById('sm4-speed'),
            sm4Total: document.getElementById('sm4-total'),
            threadStatus: document.getElementById('thread-status'),
            
            // 结果数据
            sm3Avg: document.getElementById('sm3-avg'),
            sm4Avg: document.getElementById('sm4-avg'),
            sm3Rating: document.getElementById('sm3-rating'),
            sm4Rating: document.getElementById('sm4-rating'),
            overallScore: document.getElementById('overall-score'),
            performanceRating: document.getElementById('performance-rating'),
            scoreBar: document.getElementById('score-bar'),
            completedTime: document.getElementById('completed-time'),
            
            // 历史记录
            noHistory: document.getElementById('no-history'),
            historyContainer: document.getElementById('history-container'),
            historyList: document.getElementById('history-list'),
            clearHistory: document.getElementById('clear-history'),
            saveResult: document.getElementById('save-result'),
            
            // 通知
            toast: document.getElementById('toast'),
            toastIcon: document.getElementById('toast-icon'),
            toastMessage: document.getElementById('toast-message')
        };
        
        // 全局变量
        let workers = [];
        let workerScriptUrl = null;
        let realtimeChart = null;
        let resultsChart = null;
        let testResults = null;
        let history = []; // 初始化空数组，稍后会从localStorage加载
        let testStartTime = 0;
        let workerStats = {}; // 存储每个worker的统计信息
        let totalSM3Count = 0;
        let totalSM4Count = 0;
        let cpuCoreCount = navigator.hardwareConcurrency || 4;
        
        // 初始化
        function init() {
            // 显示CPU核心数
            elements.cpuCores.textContent = `${cpuCoreCount} 核心`;
            
            // 准备Worker脚本
            try {
                const workerScript = document.getElementById('worker-script').textContent;
                const blob = new Blob([workerScript], { type: 'application/javascript' });
                workerScriptUrl = URL.createObjectURL(blob);
            } catch (error) {
                console.error('创建Worker脚本失败:', error);
                showToast('无法初始化测试环境，请检查浏览器支持', 'error');
                elements.startTest.disabled = true;
                return;
            }
            
            // 初始化图表
            initCharts();
            
            // 加载系统信息
            loadSystemInfo();
            
            // 加载历史记录 - 增加错误处理
            loadHistory();
            
            // 更新时间
            updateSystemTime();
            setInterval(updateSystemTime, 1000);
            
            // 事件监听
            setupEventListeners();
        }
        
        // 初始化图表
        function initCharts() {
            // 实时图表
            const realtimeCtx = document.getElementById('realtime-chart').getContext('2d');
            realtimeChart = new Chart(realtimeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'SM3 速度 (哈希/秒)',
                            data: [],
                            borderColor: '#165DFF',
                            backgroundColor: 'rgba(22, 93, 255, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'SM4 速度 (加密/秒)',
                            data: [],
                            borderColor: '#36CFC9',
                            backgroundColor: 'rgba(54, 207, 201, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间 (秒)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '操作/秒'
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
            
            // 结果图表
            const resultsCtx = document.getElementById('results-chart').getContext('2d');
            resultsChart = new Chart(resultsCtx, {
                type: 'bar',
                data: {
                    labels: ['SM3 平均速度', 'SM4 平均速度'],
                    datasets: [{
                        label: '操作/秒',
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(22, 93, 255, 0.7)',
                            'rgba(54, 207, 201, 0.7)'
                        ],
                        borderColor: [
                            'rgba(22, 93, 255, 1)',
                            'rgba(54, 207, 201, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '操作/秒'
                            }
                        }
                    }
                }
            });
        }
        
        // 加载系统信息
        function loadSystemInfo() {
            // 浏览器信息
            const browserName = navigator.userAgent.match(/(chrome|firefox|safari|edge|opera)/i)?.[0] || '未知浏览器';
            const browserVersion = navigator.userAgent.match(/(version|chrome|firefox|safari|edge|opera)\/(\d+\.\d+)/i)?.[2] || '未知版本';
            elements.browserInfo.textContent = `${browserName.charAt(0).toUpperCase() + browserName.slice(1)} ${browserVersion}`;
            
            // 内存信息
            if (navigator.deviceMemory) {
                elements.memoryInfo.textContent = `${navigator.deviceMemory} GB`;
            } else {
                elements.memoryInfo.textContent = '无法获取';
            }
        }
        
        // 更新系统时间
        function updateSystemTime() {
            const now = new Date();
            elements.systemTime.textContent = now.toLocaleString();
        }
        
        // 加载历史记录 - 增加数据验证
        function loadHistory() {
            try {
                // 从localStorage加载并验证数据
                const storedHistory = localStorage.getItem('cpuTestHistory');
                if (storedHistory) {
                    const parsed = JSON.parse(storedHistory);
                    // 验证是否为数组
                    if (Array.isArray(parsed)) {
                        // 过滤并验证每个历史记录项
                        history = parsed.filter(item => {
                            // 基本验证：确保是对象且包含必要字段
                            if (typeof item !== 'object' || item === null) return false;
                            
                            // 为缺失的字段设置默认值
                            if (item.sm3Speed === undefined) item.sm3Speed = 0;
                            if (item.sm4Speed === undefined) item.sm4Speed = 0;
                            if (item.score === undefined) item.score = 0;
                            if (item.threads === undefined) item.threads = 1;
                            if (item.timestamp === undefined) item.timestamp = new Date().toISOString();
                            
                            // 确保数值字段是数字
                            item.sm3Speed = Number(item.sm3Speed) || 0;
                            item.sm4Speed = Number(item.sm4Speed) || 0;
                            item.score = Number(item.score) || 0;
                            item.threads = Number(item.threads) || 1;
                            
                            return true;
                        });
                    } else {
                        console.warn('历史记录格式不正确，已重置');
                        history = [];
                    }
                } else {
                    history = [];
                }
            } catch (error) {
                console.error('加载历史记录失败:', error);
                showToast('历史记录加载失败，已重置', 'error');
                history = [];
                localStorage.removeItem('cpuTestHistory'); // 清除损坏的数据
            }
            
            if (history.length === 0) {
                elements.noHistory.classList.remove('hidden');
                elements.historyContainer.classList.add('hidden');
                return;
            }
            
            elements.noHistory.classList.add('hidden');
            elements.historyContainer.classList.remove('hidden');
            elements.historyList.innerHTML = '';
            
            // 按时间倒序排列
            history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            history.forEach((item, index) => {
                // 确保所有必要字段都存在且有效
                const sm3Speed = item.sm3Speed || 0;
                const sm4Speed = item.sm4Speed || 0;
                const score = item.score || 0;
                const threads = item.threads || 1;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${new Date(item.timestamp).toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${sm3Speed.toLocaleString()} 哈希/秒</td>
                    <td class="px-4 py-3 whitespace-nowrap">${sm4Speed.toLocaleString()} 加密/秒</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full bg-primary/10 text-primary text-sm">${score}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">${threads}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button class="text-primary hover:text-primary/80 mr-3 view-history" data-index="${index}">
                            <i class="fa fa-eye"></i> 查看
                        </button>
                        <button class="text-danger hover:text-danger/80 delete-history" data-index="${index}">
                            <i class="fa fa-trash-o"></i> 删除
                        </button>
                    </td>
                `;
                elements.historyList.appendChild(row);
            });
            
            // 添加历史记录事件监听
            document.querySelectorAll('.view-history').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    showHistoryResult(history[index]);
                });
            });
            
            document.querySelectorAll('.delete-history').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    deleteHistoryItem(index);
                });
            });
        }
        
        // 显示历史记录结果
        function showHistoryResult(item) {
            // 确保数据安全
            const sm3Speed = item.sm3Speed || 0;
            const sm4Speed = item.sm4Speed || 0;
            const score = item.score || 0;
            
            elements.testingView.classList.add('hidden');
            elements.readyView.classList.add('hidden');
            elements.completedView.classList.remove('hidden');
            
            elements.sm3Avg.textContent = sm3Speed.toLocaleString();
            elements.sm4Avg.textContent = sm4Speed.toLocaleString();
            elements.overallScore.textContent = score;
            elements.completedTime.textContent = `测试时间: ${new Date(item.timestamp).toLocaleString()} (${item.duration || 0}秒)`;
            
            // 设置评级
            setRating(elements.sm3Rating, sm3Speed, 'sm3');
            setRating(elements.sm4Rating, sm4Speed, 'sm4');
            
            // 设置性能评分
            elements.performanceRating.textContent = getPerformanceRating(score);
            elements.scoreBar.style.width = `${Math.min(score, 100)}%`;
            
            // 更新结果图表
            resultsChart.data.datasets[0].data = [sm3Speed, sm4Speed];
            resultsChart.update();
        }
        
        // 删除历史记录项
        function deleteHistoryItem(index) {
            history.splice(index, 1);
            localStorage.setItem('cpuTestHistory', JSON.stringify(history));
            loadHistory();
            showToast('历史记录已删除', 'info');
        }
        
        // 清空历史记录
        function clearAllHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                history = [];
                localStorage.setItem('cpuTestHistory', JSON.stringify(history));
                loadHistory();
                showToast('所有历史记录已清空', 'info');
            }
        }
        
        // 设置事件监听
        function setupEventListeners() {
            // 移动端菜单
            elements.mobileMenuButton.addEventListener('click', () => {
                elements.mobileMenu.classList.toggle('hidden');
            });
            
            // 导航链接点击关闭移动菜单
            elements.navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    elements.mobileMenu.classList.add('hidden');
                });
            });
            
            // 测试时长滑块
            elements.testDuration.addEventListener('input', (e) => {
                elements.durationValue.textContent = `${e.target.value}秒`;
            });
            
            // 无限测试复选框
            elements.infiniteTest.addEventListener('change', (e) => {
                elements.testDuration.disabled = e.target.checked;
            });
            
            // 开始测试按钮
            elements.startTest.addEventListener('click', startTest);
            
            // 停止测试按钮
            elements.stopTest.addEventListener('click', stopTest);
            
            // 保存结果按钮
            elements.saveResult.addEventListener('click', saveCurrentResult);
            
            // 清空历史记录按钮
            elements.clearHistory.addEventListener('click', clearAllHistory);
            
            // 监听滚动事件，改变导航栏样式
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    elements.navbar.classList.add('py-2', 'shadow-lg');
                    elements.navbar.classList.remove('py-3', 'shadow-md');
                } else {
                    elements.navbar.classList.add('py-3', 'shadow-md');
                    elements.navbar.classList.remove('py-2', 'shadow-lg');
                }
            });
        }
        
        // 获取实际线程数
        function getActualThreadCount() {
            const threadCount = elements.threadCount.value;
            if (threadCount === 'auto') {
                // 自动模式下使用CPU核心数，但不超过8个线程以避免性能问题
                return Math.min(cpuCoreCount, 8);
            }
            return parseInt(threadCount);
        }
        
        // 开始测试
        function startTest() {
            // 先停止任何正在运行的测试
            stopTest();
            
            // 验证至少选择了一个算法
            if (!elements.testSm3.checked && !elements.testSm4.checked) {
                showToast('请至少选择一个测试算法', 'error');
                return;
            }
            
            // 获取线程数
            const threadCount = getActualThreadCount();
            
            // 重置图表数据
            realtimeChart.data.labels = [];
            realtimeChart.data.datasets[0].data = [];
            realtimeChart.data.datasets[1].data = [];
            realtimeChart.update();
            
            // 切换视图
            elements.readyView.classList.add('hidden');
            elements.completedView.classList.add('hidden');
            elements.testingView.classList.remove('hidden');
            elements.progressContainer.classList.remove('hidden');
            
            // 更新UI状态
            elements.startTest.disabled = true;
            elements.stopTest.disabled = false;
            elements.testDuration.disabled = elements.infiniteTest.checked;
            elements.testSm3.disabled = true;
            elements.testSm4.disabled = true;
            elements.dataSize.disabled = true;
            elements.threadCount.disabled = true;
            elements.infiniteTest.disabled = true;
            
            // 重置计数器
            elements.sm3Speed.textContent = '0';
            elements.sm3Total.textContent = '0';
            elements.sm4Speed.textContent = '0';
            elements.sm4Total.textContent = '0';
            elements.progressBar.style.width = '0%';
            elements.progressPercentage.textContent = '0%';
            elements.testStatus.textContent = '初始化测试...';
            
            // 重置线程状态显示
            elements.threadStatus.innerHTML = '';
            for (let i = 0; i < threadCount; i++) {
                const threadIndicator = document.createElement('div');
                threadIndicator.className = 'px-2 py-1 bg-gray-100 rounded text-xs flex items-center';
                threadIndicator.id = `thread-indicator-${i}`;
                threadIndicator.innerHTML = `
                    <span class="inline-block w-2 h-2 rounded-full bg-gray-400 mr-1"></span>
                    线程 ${i+1}
                `;
                elements.threadStatus.appendChild(threadIndicator);
            }
            
            // 初始化统计数据
            totalSM3Count = 0;
            totalSM4Count = 0;
            workerStats = {};
            for (let i = 0; i < threadCount; i++) {
                workerStats[i] = {
                    sm3Count: 0,
                    sm4Count: 0,
                    lastSm3Count: 0,
                    lastSm4Count: 0,
                    isRunning: false
                };
            }
            
            // 记录测试开始时间
            testStartTime = Date.now();
            
            // 创建并启动工作线程
            workers = [];
            for (let i = 0; i < threadCount; i++) {
                const worker = new Worker(workerScriptUrl);
                workers.push(worker);
                
                // 设置Worker消息处理
                worker.onmessage = (e) => handleWorkerMessage(e, i);
                
                // 监听Worker错误
                worker.onerror = (error) => {
                    console.error(`Worker ${i} 错误:`, error);
                    showToast(`线程 ${i+1} 发生错误: ${error.message}`, 'error');
                    updateThreadStatus(i, 'error');
                };
                
                // 启动Worker
                worker.postMessage({
                    type: 'start',
                    workerId: i,
                    duration: parseInt(elements.testDuration.value),
                    isInfinite: elements.infiniteTest.checked,
                    testSM3: elements.testSm3.checked,
                    testSM4: elements.testSm4.checked,
                    dataSize: elements.dataSize.value
                });
            }
        }
        
        // 更新线程状态显示
        function updateThreadStatus(workerId, status) {
            const indicator = document.getElementById(`thread-indicator-${workerId}`);
            if (!indicator) return;
            
            let statusClass, statusText;
            switch(status) {
                case 'running':
                    statusClass = 'bg-primary/10 text-primary';
                    statusText = '<span class="inline-block w-2 h-2 rounded-full bg-primary mr-1 pulse-animation"></span>';
                    break;
                case 'completed':
                    statusClass = 'bg-success/10 text-success';
                    statusText = '<span class="inline-block w-2 h-2 rounded-full bg-success mr-1"></span>';
                    break;
                case 'error':
                    statusClass = 'bg-danger/10 text-danger';
                    statusText = '<span class="inline-block w-2 h-2 rounded-full bg-danger mr-1"></span>';
                    break;
                default:
                    statusClass = 'bg-gray-100';
                    statusText = '<span class="inline-block w-2 h-2 rounded-full bg-gray-400 mr-1"></span>';
            }
            
            indicator.className = `px-2 py-1 ${statusClass} rounded text-xs flex items-center`;
            indicator.innerHTML = `${statusText} 线程 ${workerId+1}`;
        }
        
        // 停止测试
        function stopTest() {
            if (workers.length > 0 && elements.stopTest.disabled === false) {
                elements.testStatus.textContent = '正在停止测试...';
                elements.stopTest.disabled = true;
                
                // 向所有Worker发送停止消息
                workers.forEach(worker => {
                    if (worker) {
                        try {
                            worker.postMessage({ type: 'stop' });
                        } catch (error) {
                            console.error('发送停止消息失败:', error);
                        }
                    }
                });
            }
        }
        
        // 处理Worker消息
        function handleWorkerMessage(e, workerId) {
            const data = e.data;
            
            // 更新 worker 统计信息
            if (!workerStats[workerId]) {
                workerStats[workerId] = {
                    sm3Count: 0,
                    sm4Count: 0,
                    lastSm3Count: 0,
                    lastSm4Count: 0,
                    isRunning: false
                };
            }
            
            const stats = workerStats[workerId];
            
            switch(data.type) {
                case 'started':
                    stats.isRunning = true;
                    updateThreadStatus(workerId, 'running');
                    
                    // 检查是否所有线程都已启动
                    const allStarted = Object.values(workerStats).every(s => s.isRunning);
                    if (allStarted) {
                        elements.testStatus.textContent = '测试进行中...';
                    }
                    break;
                    
                case 'progress':
                    // 更新该worker的计数
                    stats.sm3Count = data.sm3Count;
                    stats.sm4Count = data.sm4Count;
                    
                    // 计算总计数
                    totalSM3Count = Object.values(workerStats).reduce((sum, s) => sum + s.sm3Count, 0);
                    totalSM4Count = Object.values(workerStats).reduce((sum, s) => sum + s.sm4Count, 0);
                    
                    // 计算已运行时间
                    const elapsed = (Date.now() - testStartTime) / 1000;
                    
                    // 更新计数器显示
                    elements.sm3Total.textContent = totalSM3Count.toLocaleString();
                    elements.sm4Total.textContent = totalSM4Count.toLocaleString();
                    
                    // 计算速度 (操作/秒)
                    const sm3Speed = elapsed > 0 ? Math.round(totalSM3Count / elapsed) : 0;
                    const sm4Speed = elapsed > 0 ? Math.round(totalSM4Count / elapsed) : 0;
                    
                    elements.sm3Speed.textContent = sm3Speed.toLocaleString();
                    elements.sm4Speed.textContent = sm4Speed.toLocaleString();
                    
                    // 更新进度（如果不是无限模式）
                    if (!elements.infiniteTest.checked) {
                        elements.progressBar.style.width = `${data.progress}%`;
                        elements.progressPercentage.textContent = `${Math.round(data.progress)}%`;
                    } else {
                        // 无限模式下显示已运行时间
                        elements.progressPercentage.textContent = `${elapsed.toFixed(1)}秒`;
                        elements.progressBar.style.width = '100%';
                    }
                    
                    // 更新实时图表 (每1秒更新一次)
                    const currentSecond = Math.round(elapsed);
                    if (currentSecond > 0 && realtimeChart.data.labels.indexOf(currentSecond.toString()) === -1) {
                        realtimeChart.data.labels.push(currentSecond.toString());
                        realtimeChart.data.datasets[0].data.push(sm3Speed);
                        realtimeChart.data.datasets[1].data.push(sm4Speed);
                        
                        // 限制图表数据点数量
                        if (realtimeChart.data.labels.length > 30) {
                            realtimeChart.data.labels.shift();
                            realtimeChart.data.datasets[0].data.shift();
                            realtimeChart.data.datasets[1].data.shift();
                        }
                        
                        realtimeChart.update();
                    }
                    break;
                    
                case 'complete':
                case 'stopped':
                    stats.isRunning = false;
                    updateThreadStatus(workerId, 'completed');
                    
                    // 检查是否所有线程都已完成
                    const allCompleted = Object.values(workerStats).every(s => !s.isRunning);
                    if (allCompleted) {
                        // 计算总计数
                        totalSM3Count = Object.values(workerStats).reduce((sum, s) => sum + s.sm3Count, 0);
                        totalSM4Count = Object.values(workerStats).reduce((sum, s) => sum + s.sm4Count, 0);
                        
                        // 计算总运行时间
                        const duration = (Date.now() - testStartTime) / 1000;
                        
                        // 计算平均速度
                        const sm3Avg = duration > 0 ? Math.round(totalSM3Count / duration) : 0;
                        const sm4Avg = duration > 0 ? Math.round(totalSM4Count / duration) : 0;
                        
                        // 保存测试结果
                        testResults = {
                            timestamp: new Date().toISOString(),
                            duration: Math.round(duration),
                            sm3Speed: sm3Avg,
                            sm4Speed: sm4Avg,
                            score: calculateScore(sm3Avg, sm4Avg),
                            testSM3: elements.testSm3.checked,
                            testSM4: elements.testSm4.checked,
                            dataSize: elements.dataSize.value,
                            threads: getActualThreadCount()
                        };
                        
                        // 显示结果视图
                        showTestResults();
                        
                        // 清理工作线程
                        workers.forEach(worker => {
                            if (worker) {
                                try {
                                    worker.terminate();
                                } catch (error) {
                                    console.error('终止Worker失败:', error);
                                }
                            }
                        });
                        workers = [];
                        
                        // 恢复UI状态
                        resetTestUI();
                        
                        showToast(data.type === 'complete' ? '测试已完成' : '测试已停止', 'success');
                    }
                    break;
                    
                case 'error':
                    stats.isRunning = false;
                    updateThreadStatus(workerId, 'error');
                    showToast(`线程 ${workerId+1} 出错: ${data.message}`, 'error');
                    break;
            }
        }
        
        // 显示测试结果
        function showTestResults() {
            if (!testResults) return;
            
            // 切换视图
            elements.testingView.classList.add('hidden');
            elements.completedView.classList.remove('hidden');
            
            // 更新结果数据
            elements.sm3Avg.textContent = testResults.sm3Speed.toLocaleString();
            elements.sm4Avg.textContent = testResults.sm4Speed.toLocaleString();
            elements.overallScore.textContent = testResults.score;
            elements.completedTime.textContent = `测试时间: ${new Date(testResults.timestamp).toLocaleString()} (${testResults.duration}秒)`;
            
            // 设置评级
            setRating(elements.sm3Rating, testResults.sm3Speed, 'sm3');
            setRating(elements.sm4Rating, testResults.sm4Speed, 'sm4');
            
            // 设置性能评分
            elements.performanceRating.textContent = getPerformanceRating(testResults.score);
            elements.scoreBar.style.width = `${Math.min(testResults.score, 100)}%`;
            
            // 更新结果图表
            resultsChart.data.datasets[0].data = [testResults.sm3Speed, testResults.sm4Speed];
            resultsChart.update();
        }
        
        // 重置测试UI
        function resetTestUI() {
            elements.startTest.disabled = false;
            elements.stopTest.disabled = true;
            elements.testDuration.disabled = elements.infiniteTest.checked;
            elements.testSm3.disabled = false;
            elements.testSm4.disabled = false;
            elements.dataSize.disabled = false;
            elements.threadCount.disabled = false;
            elements.infiniteTest.disabled = false;
            elements.progressBar.style.width = '100%';
            elements.progressPercentage.textContent = elements.infiniteTest.checked ? '已停止' : '100%';
            elements.testStatus.textContent = '测试已完成';
        }
        
        // 计算综合得分 (0-100)
        function calculateScore(sm3Speed, sm4Speed) {
            // 调整基准值，使其更符合实际设备性能
            const sm3Base = 20000 * (getActualThreadCount() / 4);
            const sm4Base = 15000 * (getActualThreadCount() / 4);
            
            let sm3Score = Math.min(100, (sm3Speed / sm3Base) * 100);
            let sm4Score = Math.min(100, (sm4Speed / sm4Base) * 100);
            
            // 如果未测试某个算法，只使用已测试的算法得分
            if (!elements.testSm3.checked) {
                return Math.round(sm4Score);
            } else if (!elements.testSm4.checked) {
                return Math.round(sm3Score);
            }
            
            // 综合得分 (SM3和SM4各占50%)
            return Math.round((sm3Score * 0.5) + (sm4Score * 0.5));
        }
        
        // 设置评级
        function setRating(element, value, type) {
            let rating, color;
            
            // 根据算法类型设置不同的评级阈值，并考虑线程数
            const threadFactor = getActualThreadCount() / 4;
            const sm3Thresholds = [5000, 10000, 20000].map(t => t * threadFactor);
            const sm4Thresholds = [3000, 8000, 15000].map(t => t * threadFactor);
            
            // 确保value是数字
            const numericValue = Number(value) || 0;
            
            if (type === 'sm3') {
                if (numericValue < sm3Thresholds[0]) {
                    rating = '较低';
                    color = 'bg-danger/10 text-danger';
                } else if (numericValue < sm3Thresholds[1]) {
                    rating = '中等';
                    color = 'bg-warning/10 text-warning';
                } else if (numericValue < sm3Thresholds[2]) {
                    rating = '良好';
                    color = 'bg-primary/10 text-primary';
                } else {
                    rating = '优秀';
                    color = 'bg-success/10 text-success';
                }
            } else { // sm4
                if (numericValue < sm4Thresholds[0]) {
                    rating = '较低';
                    color = 'bg-danger/10 text-danger';
                } else if (numericValue < sm4Thresholds[1]) {
                    rating = '中等';
                    color = 'bg-warning/10 text-warning';
                } else if (numericValue < sm4Thresholds[2]) {
                    rating = '良好';
                    color = 'bg-primary/10 text-primary';
                } else {
                    rating = '优秀';
                    color = 'bg-success/10 text-success';
                }
            }
            
            element.textContent = `评级: ${rating}`;
            element.className = `px-2 py-1 rounded-full text-sm ${color}`;
        }
        
        // 获取性能评价
        function getPerformanceRating(score) {
            const numericScore = Number(score) || 0;
            if (numericScore < 30) return '较低性能';
            if (numericScore < 60) return '中等性能';
            if (numericScore < 80) return '良好性能';
            return '高性能';
        }
        
        // 保存当前结果
        function saveCurrentResult() {
            if (!testResults) return;
            
            // 检查是否已保存
            const exists = history.some(item => item.timestamp === testResults.timestamp);
            if (exists) {
                showToast('该结果已保存', 'info');
                return;
            }
            
            // 添加到历史记录
            history.push(testResults);
            localStorage.setItem('cpuTestHistory', JSON.stringify(history));
            
            // 更新历史记录显示
            loadHistory();
            
            showToast('测试结果已保存', 'success');
        }
        
        // 显示通知提示
        function showToast(message, type = 'success') {
            // 设置图标和颜色
            switch(type) {
                case 'success':
                    elements.toastIcon.className = 'fa fa-check-circle mr-2 text-success';
                    break;
                case 'error':
                    elements.toastIcon.className = 'fa fa-exclamation-circle mr-2 text-danger';
                    break;
                case 'info':
                    elements.toastIcon.className = 'fa fa-info-circle mr-2 text-primary';
                    break;
                case 'warning':
                    elements.toastIcon.className = 'fa fa-warning mr-2 text-warning';
                    break;
            }
            
            // 设置消息
            elements.toastMessage.textContent = message;
            
            // 显示提示
            elements.toast.classList.remove('translate-y-20', 'opacity-0');
            elements.toast.classList.add('translate-y-0', 'opacity-100');
            
            // 3秒后隐藏
            setTimeout(() => {
                elements.toast.classList.remove('translate-y-0', 'opacity-100');
                elements.toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        // 页面关闭时清理资源
        window.addEventListener('beforeunload', () => {
            workers.forEach(worker => {
                if (worker) {
                    try {
                        worker.terminate();
                    } catch (error) {
                        console.error('终止Worker失败:', error);
                    }
                }
            });
            
            if (workerScriptUrl) {
                URL.revokeObjectURL(workerScriptUrl);
            }
        });
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
